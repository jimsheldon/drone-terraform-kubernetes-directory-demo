################################################################################
# the default pipeline runs on commits to the 'main' branch, or pull requests
# where the 'main' branch is the target
################################################################################
kind: pipeline
name: default

################################################################################
# trigger this pipeline on commits to the 'main' branch (or on pull requests
# where the target branch is 'main')
################################################################################
trigger:
  branch:
  - main

################################################################################
# remove this 'platform' section if your CPU is amd64 architecture
################################################################################
platform:
  os: linux
  arch: arm64

################################################################################
# limit 'concurrency' to 1 to ensure only one pipeline runs at a time
################################################################################
concurrency:
  limit: 1

################################################################################
# create a temporary volume that will be used to share the /root/.kube directory
# between pipeline steps
################################################################################
volumes:
- name: dot-kube
  temp: {}

################################################################################
# pipeline steps start here
################################################################################
steps:

################################################################################
# read the 'kube_config' secret which contains the kubernetes config file,
# base64-encoded, and write it to /root/.kube/config
################################################################################
- name: kube config
  image: alpine:3
  environment:
    KUBE_CONFIG:
      from_secret: kube_config
  commands:
  - echo $KUBE_CONFIG | base64 -d > /root/.kube/config
  volumes:
  - name: dot-kube
    path: /root/.kube

################################################################################
# when .tf files beneath the 'dev' directory change, run 'terraform fmt -check'
# to ensure consistent formatting, then run 'terraform init' with the necessary
# parameters for the kubernetes backend
################################################################################
- name: terraform init (dev)
  image: hashicorp/terraform:1.1.8
  commands:
  - cd $DRONE_WORKSPACE/dev; terraform fmt -check
  - cd $DRONE_WORKSPACE/dev; terraform init -backend-config="secret_suffix=directory-dev" -backend-config="namespace=demo-dev"
  volumes:
  - name: dot-kube
    path: /root/.kube
  when:
    paths:
    - dev/*.tf

################################################################################
# when .tf files beneath the 'dev' directory change in a pull request, run
# 'terraform plan' to show what will be changed
################################################################################
- name: terraform plan (dev)
  image: hashicorp/terraform:1.1.8
  commands:
  - cd $DRONE_WORKSPACE/dev; terraform plan
  volumes:
  - name: dot-kube
    path: /root/.kube
  when:
    event:
    - pull_request
  when:
    paths:
    - dev/*.tf

################################################################################
# when .tf files beneath the 'prod' directory change, run 'terraform fmt -check'
# to ensure consistent formatting, then run 'terraform init' with the necessary
# parameters for the kubernetes backend
################################################################################
- name: terraform init (prod)
  image: hashicorp/terraform:1.1.8
  commands:
  - cd $DRONE_WORKSPACE/prod; terraform fmt -check
  - cd $DRONE_WORKSPACE/prod; terraform init -backend-config="secret_suffix=directory-prod" -backend-config="namespace=demo-prod"
  volumes:
  - name: dot-kube
    path: /root/.kube
  when:
    paths:
    - prod/*.tf

################################################################################
# when .tf files beneath the 'prod' directory change in a pull request, run
# 'terraform plan' to show what will be changed
################################################################################
- name: terraform plan (prod)
  image: hashicorp/terraform:1.1.8
  commands:
  - cd $DRONE_WORKSPACE/prod; terraform plan
  volumes:
  - name: dot-kube
    path: /root/.kube
  when:
    event:
    - pull_request
  when:
    paths:
    - prod/*.tf

################################################################################
# when .tf files are changed in the 'dev' directory on push events, run
# 'terraform apply' in the 'dev' directory (the 'trigger' section ensures that
# only changes to the 'main' branch will trigger this pipeline, so this step
# does not need an explicit reference to the 'main' branch)
################################################################################
- name: terraform apply (dev)
  image: hashicorp/terraform:1.1.8
  commands:
  - cd $DRONE_WORKSPACE/dev; terraform apply -auto-approve
  volumes:
  - name: dot-kube
    path: /root/.kube
  when:
    event:
    - push
  when:
    paths:
    - dev/*.tf

################################################################################
# when .tf files are changed in the 'prod' directory on push events, run
# 'terraform apply' in the 'prod' directory (the 'trigger' section ensures that
# only changes to the 'main' branch will trigger this pipeline, so this step
# does not need an explicit reference to the 'main' branch)
################################################################################
- name: terraform apply (prod)
  image: hashicorp/terraform:1.1.8
  commands:
  - cd $DRONE_WORKSPACE/prod; terraform apply -auto-approve
  volumes:
  - name: dot-kube
    path: /root/.kube
  when:
    event:
    - push
  when:
    paths:
    - prod/*.tf
